name: Publish

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  publish-go-module:
    if: github.event.release.prerelease == false
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ github.event.release.tag_name }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'

      - name: Validate release tag format and VERSION match
        run: |
          TAG="${{ github.event.release.tag_name }}"
          case "$TAG" in
            v*) ;;
            *)
              echo "Release tag must start with 'v' (got: $TAG)"
              exit 1
              ;;
          esac

          TAG_NO_V="${TAG#v}"
          VERSION_FILE=$(tr -d '[:space:]' < VERSION)
          test "$TAG_NO_V" = "$VERSION_FILE"

      - name: Trigger Go module proxy indexing
        env:
          MODULE: github.com/rapidclock/web-octopus
        run: |
          set -euo pipefail
          VERSION="${{ github.event.release.tag_name }}"
          URL="https://proxy.golang.org/${MODULE}/@v/${VERSION}.info"
          for i in 1 2 3 4 5; do
            if curl -fsSL "$URL" >/dev/null; then
              exit 0
            fi
            sleep $((i * 2))
          done
          echo "failed to fetch module info from proxy after retries"
          exit 1

      - name: Trigger pkg.go.dev refresh
        env:
          MODULE: github.com/rapidclock/web-octopus
        run: |
          set -euo pipefail
          VERSION="${{ github.event.release.tag_name }}"
          URL="https://pkg.go.dev/fetch/${MODULE}@${VERSION}"
          for i in 1 2 3 4 5; do
            if curl -fsSL "$URL" >/dev/null; then
              exit 0
            fi
            sleep $((i * 2))
          done
          echo "failed to trigger pkg.go.dev refresh after retries"
          exit 1
